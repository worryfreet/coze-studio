# 后端目录与开发入口（AI 代理用）

## 总览：分层与职责

后端目录在 `backend/`，整体是 DDD 分层：

- `backend/api/`：HTTP 接入层（Hertz）。包含
  - `backend/api/router/`：根据 IDL 生成的路由注册（一般不直接手改）。
  - `backend/api/handler/`：HTTP handler（对接 `application/*`），通常实现参数校验、调用应用服务、返回结构化响应。
  - `backend/api/middleware/`：全局中间件（鉴权、日志、i18n、context 缓存等）。
  - `backend/api/model/`：IDL 生成的请求/响应结构体（一般不直接手改）。
- `backend/application/`：应用层（用例编排、跨领域组合、事务边界），并在 `backend/application/application.go` 内完成依赖装配与跨域 SVC 注入。
- `backend/domain/`：领域层（实体/值对象/领域服务/内部模块），聚焦业务规则。
- `backend/crossdomain/`：跨域门面/适配层（对外暴露领域能力的统一入口，默认 SVC 在 `application.Init` 时注入）。
- `backend/infra/`：基础设施层（DB/缓存/对象存储/搜索/事件总线等实现）。
- `backend/conf/`：配置文件与模板（如模型、插件、工作流等）。
- `backend/types/`：跨层通用类型与常量（如 `consts`、`errno`）。
- `backend/pkg/`：通用工具（与业务弱耦合）。
- `backend/bizpkg/`：偏业务的公共包（与领域有一定耦合的复用逻辑）。

## 入口与路由

- 服务入口：`backend/main.go`（初始化应用层并启动 Hertz）。
- 路由注册：`backend/api/router/register.go` → `backend/api/router/coze/api.go`（从 `idl/api.thrift` 聚合出的 master IDL 生成）。

## 鉴权链路（改鉴权通常看这里）

### 鉴权类型判定

`backend/api/middleware/request_inspector.go` 根据 path 判定请求类型：

- Web API：默认类型，走 cookie session（多为 `/api/**`）。
- OpenAPI：在 `backend/api/middleware/openapi_auth.go` 的 `needAuthPath/needAuthFunc` 命中时判定为 OpenAPI（多为 `/v1/**`、`/v3/**`）。
- StaticFile：静态资源与页面路由。

### 鉴权执行

中间件注册在 `backend/main.go`，顺序为：

`ContextCacheMW` → `RequestInspectorMW` → `OpenapiAuthMW` → `SessionAuthMW` → `I18nMW`

其中：

- OpenAPI：`backend/api/middleware/openapi_auth.go` 校验 `Authorization: Bearer <token>`，将 apiKey 信息写入 `ctxcache`（key：`consts.OpenapiAuthKeyInCtx`）。
- Web API：`backend/api/middleware/session.go` 从 cookie `session_key` 取 session，调用 `user.UserApplicationSVC.ValidateSession` 校验并写入 `ctxcache`（key：`consts.SessionDataKeyInCtx`）。
- Admin：`backend/api/middleware/session.go` 的 `AdminAuthMW`（目前仅在 `/api/admin/**` group 上启用，见 `backend/api/router/coze/middleware.go`）。

建议在业务代码里通过：

- `backend/application/base/ctxutil/api_auth.go` 获取 OpenAPI 身份。
- `backend/application/base/ctxutil/session.go` 获取 Web Session 身份。

而不是在 handler 内自行解析 header/cookie。

## API 增改（改接口通常看这里）

### 1) 改合同：IDL（Thrift）

优先从 `idl/` 入手（例如 `idl/api.thrift` 与其 include 的各模块 thrift）。

### 2) 生成代码：router/model/handler

路由与 model 位于：

- `backend/api/router/`
- `backend/api/model/`

它们一般是生成产物：新增/调整接口时，应以 IDL 为源头再生成，避免直接改生成文件导致后续覆盖。

### 3) 实现逻辑：handler → application → domain/infra

落地改动通常分三层：

- `backend/api/handler/coze/*.go`：参数绑定与校验、调用应用服务、返回错误码/响应。
- `backend/application/<module>/`：用例编排、权限校验、跨域组合。
- `backend/domain/<module>/`：核心业务规则；需要外部依赖时通过 `infra` 注入。

### 4) 需要同步更新的“隐性点”

当你新增 OpenAPI 的 `/v1/**`、`/v3/**` 路径且希望走 OpenAPI 鉴权时，记得同步更新：

- `backend/api/middleware/openapi_auth.go`：`needAuthPath/needAuthFunc`

当你新增无需 session 的登录/注册类 Web API 时，记得同步更新：

- `backend/api/middleware/session.go`：`noNeedSessionCheckPath`

## 代码生成（Hertz / Thrift / GORM）

### Hertz（HTTP handler/router 生成）

本仓库的 `backend/api/router/`、`backend/api/handler/`、`backend/main.go` 等文件带有 `// Code generated by hertz generator` 头标识，生成配置记录在 `backend/.hz`（当前为 `hz version: v0.9.7`）。

仓库内未提供固定的 `make`/`scripts` 命令来一键重跑 Hertz 生成；如需更新接口定义后重生成，通常需要安装对应版本的 `hz` 工具并在 `backend/` 目录下执行更新命令（以 `idl/api.thrift` 为 master IDL）。`idl/api.thrift` 仅通过 `service ... extends ... {}` 汇总各模块服务，生成时必须带上 `--enable_extends`（否则 router 会为空），示例：

```
hz update --enable_extends --sort_router \
  --idl ../idl/api.thrift \
  --mod github.com/coze-dev/coze-studio/backend \
  --handler_dir api/handler --model_dir api/model
```

### Thrift（Go model 生成）

`backend/api/model/` 下的 Go 文件头标识为 `// Code generated by thriftgo`（当前存在 `0.4.1` 与 `0.4.2` 两种版本的生成痕迹）。

仓库里可直接找到的自动化命令在 `.github/workflows/idl.yaml`：CI 会安装 `thriftgo`/`kitex`/`thrift-gen-validator` 并用 `kitex -streamx ...` 逐个校验/生成（在临时目录，不会回写仓库），用于保证 IDL 语法与生成可通过。

### GORM（gorm.io/gen DAL 生成）

GORM DAL 代码（如 `*/internal/dal/model/*.gen.go`、`*/internal/dal/query/*.gen.go`）由 `gorm.io/gen` 生成，生成入口脚本为 `backend/types/ddl/gen_orm_query.go`，依赖 `MYSQL_DSN` 环境变量连接本地/测试 MySQL，按脚本内的表映射批量输出到各模块的 `internal/dal` 目录。

## 基础设施补充：对象存储
- 存储实现位于 `backend/infra/storage/impl`，通过 `backend/infra/storage/impl/storage.go` 根据环境变量 `STORAGE_TYPE` 选择 minio/tos/s3/cos，bucket 统一使用 `STORAGE_BUCKET`。
- 腾讯 COS 环境变量：`COS_SECRET_ID`、`COS_SECRET_KEY`、`COS_REGION`、`COS_ENDPOINT`，与其他实现的接口能力（标签、预签名 URL、分页列举等）保持一致。
